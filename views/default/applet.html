<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Cartesian Plane</title>

        <script src="{{=URL('static','js/jquery.js')}}"></script>
        <script src="{{=URL('static','js/web2py.js')}}"></script>

        <script>
            var draggingEnabled = true;

            $(function(){
                $("#dragToggle").click(function(e){
                    draggingEnabled = !draggingEnabled;
                    pF.setLockEnabled(draggingEnabled);
                    $(this).text("Dragging " + (draggingEnabled ? "ON" : "OFF"));
                });
            });
        </script>

        <style>
            body{ 
                padding-left: 135px;
                padding-top: 70px;
            }
        </style>

    </head>
    <body>
        {{=applet}}
        <!-- Changed problem-desc from a div tag to a pre tag. Essentially did this since the text in this tag is later modified with newline characters in between and the div tag disregards the newline character and prints everything in single line. The pre tag preserves the newline and renders accordingly -->
        <pre id="problem-desc">This is the current problem</pre>
        <a href="#" id="dragToggle">Dragging ON</a>
        <script>
            var olddata = "0";
            var currentProblem;
            $(document).ready(function(){
                if(!web2py_websocket('ws://{{=ip}}:{{=port}}/realtime/{{=group_name}}',function(e){
                    console.dir(e.data);
                    incoming = JSON.parse(unescape(e.data));
                    // TODO improve detection. Encapsulate the object and include a type property
                    if(incoming instanceof Array){
                        // Execute array of actions (replay steps)
                        updateProblem();
                        actions = [];
                        for(var i = 0; i < incoming.length; i++){
                            var action = incoming[i];
                            actions.push(new Action(action.name, action.op));
                        }
                        primitiveActions.executeAction(actions);
                    } else if(incoming.label !== undefined){
                        console.dir("Execute action");
                        olddata = incoming;
                        // Execute action
                        executeAction();    
                    } else if(incoming.id !== undefined) {
                        console.dir("Update problem info");
                        // Update problem info
                        currentProblem = incoming;
                        updateProblem();
                        
                        var tmpString = currentProblem.text + "\n";
                        
                        for(var i = 0 ; i < currentProblem.prompts.length ; i++) {
                            tmpString = tmpString + Number(i+1) + " " + currentProblem.prompts[i].toString() + "\n";
                        }
                        
                        $("#problem-desc").text(tmpString);
                    } else {
                        alert("Fall through error...");
                    }
                    
                })){
                    alert("html5 websocket not supported by your browser, try Google Chrome");
                }
            });

            function updateProblem(){
                console.dir("Updating plane to problem ID #" + currentProblem.id +"...");
                pF.appReady(currentProblem.points, currentProblem.lines);
            }

            function executeAction(){
                console.log("EXECUTING CLICKLISTENER EVENT!!! " + olddata.name + " - " + olddata.op);
                clickListener.executeEvent(new Action(olddata.name, olddata.op));
            }

        </script>
    </body>
</html>


